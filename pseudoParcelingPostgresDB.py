import psycopg2



conn = psycopg2.connect("dbname=noss user=Tsengineer password=Forec@st02")
cursor = conn.cursor()

def getFourPointsFromPolygonGeom(polygonGeom):
    query = "select st_ymin(st_geomfromtext(st_astext('" + polygonGeom + "')))"
    cursor.execute(query)
    fetch = cursor.fetchall()
    ymin = fetch[0][0]

    query = "select st_ymax(st_geomfromtext(st_astext('" + polygonGeom + "')))"
    cursor.execute(query)
    fetch = cursor.fetchall()
    ymax = fetch[0][0]

    query = "select st_xmin(st_geomfromtext(st_astext('" + polygonGeom + "')))"
    cursor.execute(query)
    fetch = cursor.fetchall()
    xmin = fetch[0][0]

    query = "select st_xmax(st_geomfromtext(st_astext('" + polygonGeom + "')))"
    cursor.execute(query)
    fetch = cursor.fetchall()
    xmax = fetch[0][0]


    return (xmin,xmax,ymin,ymax)
def getAreaFromPolygonGeom(polygonGeom):
    query = "select st_area('" + polygonGeom + "')"
    cursor.execute(query)
    fetch = cursor.fetchall()[0][0]
    return fetch
def makeALine(x1,y1,x2,y2):
    query = "select st_astext(st_makeline(st_makepoint("+x1+","+y1+"),st_makepoint("+x2+","+y2+")))"
    cursor.execute(query)
    fetch = cursor.fetchall()
    line_geom = fetch[0][0]
    return line_geom
def splitPolygon(polygonGeom,lineGeom,type):
    query = "select ST_GeometryType('"+polygonGeom+"')"
    cursor.execute(query)
    fetch = cursor.fetchall()
    polygonType = fetch[0][0]
    query = ''

    query = "select ST_AsText((st_dump(st_split(st_geomfromtext(st_astext('" + polygonGeom + "')),'" + lineGeom + "'))).geom)"
    cursor.execute(query)
    fetch = cursor.fetchall()
    if len(fetch)==1:
        return fetch[0][0],None
    elif len(fetch)>2:

        if type == 'h':
            collection0 = None
            collection1 = None
            query = "select st_x(ST_StartPoint('" + lineGeom + "'::geometry))"
            cursor.execute(query)
            linex = cursor.fetchall()[0][0]
            for i in range(len(fetch)):
                xmini, xmaxi, ymini, ymaxi = getFourPointsFromPolygonGeom(fetch[i][0])
                if xmaxi <= linex:
                    if collection0 == None:
                        collection0 = fetch[i][0]
                    else:
                        query = "select st_collect('"+collection0+"','"+fetch[i][0]+"');"
                        cursor.execute(query)
                        collection0 = cursor.fetchall()[0][0]

                elif xmini >= linex:
                    if collection1 == None:
                        collection1 = fetch[i][0]
                    else:
                        query = "select st_collect('"+collection1+"','"+fetch[i][0]+"');"
                        cursor.execute(query)
                        collection1 = cursor.fetchall()[0][0]

            return collection0,collection1
        else:

            collection0 = None
            collection1 = None
            query = "select st_y(ST_StartPoint('" + lineGeom + "'::geometry))"
            cursor.execute(query)
            liney = cursor.fetchall()[0][0]
            for i in range(len(fetch)):
                xmini, xmaxi, ymini, ymaxi = getFourPointsFromPolygonGeom(fetch[i][0])
                if ymini >= liney:
                    if collection0 == None:
                        collection0 = fetch[i][0]
                    else:
                        query = "select st_collect('" + collection0 + "','"+fetch[i][0]+"');"
                        cursor.execute(query)
                        collection0 = cursor.fetchall()[0][0]

                elif ymaxi <= liney:
                    if collection1 == None:
                        collection1 = fetch[i][0]
                    else:
                        query = "select st_collect('" + collection1 + "','"+fetch[i][0]+"');"
                        cursor.execute(query)
                        collection1 = cursor.fetchall()[0][0]

            return collection0, collection1


    parcel0 = fetch[0][0]
    parcel1 = fetch[1][0]
    xmin0, xmax0, ymin0, ymax0 = getFourPointsFromPolygonGeom(parcel0)
    xmin1, xmax1, ymin1, ymax1 = getFourPointsFromPolygonGeom(parcel1)

    if type == 'h': #split horizontally

        if xmin0>xmin1:
            return parcel1,parcel0
        else: #split vertically
            return parcel0,parcel1
    else:

        if ymin0>ymin1:
            return parcel0,parcel1
        else:
            return parcel1,parcel0

def adjustYSplit(currentParcel,remainingParcel, currentBigArea,supposedArea,currentLine,tol,ystep,ymin,ymax):
    currentParcelArea = getAreaFromPolygonGeom(currentParcel)

    if abs(currentParcelArea - supposedArea) <= tol:
        pass
    elif currentParcelArea - supposedArea > 0:
        while abs(currentParcelArea - supposedArea) > tol and (currentParcelArea - supposedArea) > 0:
            query = "select st_x(ST_StartPoint('" + currentLine + "'::geometry))"
            cursor.execute(query)
            fetch = cursor.fetchall()
            currentX = fetch[0][0]
            currentX -= ystep

            currentLine = makeALine(str(currentX),str(ymin),str(currentX),str(ymax))
            currentParcel,remainingParcel = splitPolygon(currentBigArea,currentLine,'h')

            currentParcelArea = getAreaFromPolygonGeom(currentParcel)
    else:  # too small, move left
        while abs(currentParcelArea - supposedArea)> tol and (currentParcelArea - supposedArea) < 0:
            query = "select st_x(ST_StartPoint('" + currentLine + "'::geometry))"
            cursor.execute(query)
            fetch = cursor.fetchall()
            currentX = fetch[0][0]
            currentX += ystep

            currentLine = makeALine(str(currentX), str(ymin), str(currentX), str(ymax))
            currentParcel,remainingParcel = splitPolygon(currentBigArea, currentLine, 'h')

            currentParcelArea = getAreaFromPolygonGeom(currentParcel)

    return currentParcel,remainingParcel


def adjustXSplit(currentParcel,remainingParcel,currentBigArea,supposedArea,currentLine,tol,xstep,xmin,xmax):
    currentParcelArea = getAreaFromPolygonGeom(currentParcel)
    if abs(currentParcelArea - supposedArea) <= tol:
        pass
    elif currentParcelArea - supposedArea > 0:
        while abs(currentParcelArea - supposedArea) > tol and (currentParcelArea - supposedArea) > 0:
            query = "select st_y(ST_StartPoint('" + currentLine + "'::geometry))"
            cursor.execute(query)
            fetch = cursor.fetchall()
            currentY = fetch[0][0]
            currentY += xstep
            currentLine = makeALine(str(xmin),str(currentY),str(xmax),str(currentY))
            currentParcel,remainingParcel = splitPolygon(currentBigArea,currentLine,'v')
            currentParcelArea = getAreaFromPolygonGeom(currentParcel)
    else:  # too small, move left
        while abs(currentParcelArea - supposedArea) > tol and (currentParcelArea - supposedArea) < 0:
            query = "select st_y(ST_StartPoint('" + currentLine + "'::geometry))"
            cursor.execute(query)
            fetch = cursor.fetchall()
            currentY = fetch[0][0]
            currentY -= xstep

            currentLine = makeALine(str(xmin),str(currentY),str(xmax),str(currentY))
            currentParcel,remainingParcel = splitPolygon(currentBigArea, currentLine, 'V')

            currentParcelArea = getAreaFromPolygonGeom(currentParcel)
    return currentParcel,remainingParcel

def cleanAPolygon(polygonGeom):
    query="SELECT (ST_DUMP('"+polygonGeom+"')).geom"
    cursor.execute(query)
    fetch = cursor.fetchall()
    biggestParcelArea = 0.0
    biggestParcel = None
    for i in range(len(fetch)):
        currentArea = getAreaFromPolygonGeom(fetch[i][0])
        if currentArea> biggestParcelArea:
            biggestParcelArea = currentArea
            biggestParcel = fetch[i][0]

    return biggestParcel
if __name__ == '__main__':
    testgeom = '0106000020490D0000010000000103000000010000004B010000DDFF5C4A661AF840E4C4B9884CA45641F2419E3CB21AF84015E4801812A45641B825FA7AB21AF84091798AE811A45641150956B9B21AF8400B0F94B811A45641293EC97BB51AF84073EF03990FA45641EC5A8D9ACD1AF84099D40C09FDA3564191B0088DCF1AF840C9ED5289FBA3564189CDE97FD11AF84023539C09FAA35641A7AC36E2081BF840634A516ACFA35641D16388DE2F1BF8400EEC9D69B1A356412230D1A04819F8407732013FB1A35641A58D2EB34D19F8400B0CAB70ADA356419B74E60C5319F8403C645E6DA9A35641E32162146819F840891C33A799A35641F0C41AC3731CF8407627B1EA99A3564136BF91CC971CF8405E113CF27EA356417E595D0BE21CF8407C15CD6147A3564159C532E8E21CF840EC6649BC46A356418D966A67FE1CF8401C9AF92637A3564156D165ADB31EF840D2042A4837A35641A104A436D21EF8404254CCF521A3564190B6375CD41EF8408A1C1F7620A35641D627A540D51EF840EA06BBD61FA35641E818C8DED61EF840B2CCB5B51EA3564184E3E30FD91EF8405B30C22D1DA356412AB5F6829E06F8400F7F91021BA35641E4B7DE6C4A05F8400648CE8757A456414DE051345305F8408DAA328E57A456413B8952FC5B05F84096DB8A9457A4564107A4DFC46405F8405EDAD69A57A456414D21F88D6D05F84025A616A157A45641F2F19A577605F840293E4AA757A456413F07C7217F05F840ABA171AD57A4564164517BEC8705F840EDCF8CB357A45641A9C1B6B79005F84031C89BB957A45641364878839905F840BD899EBF57A45641DFD5BE4FA205F840D91395C557A456413A5B891CAB05F840CE657FCB57A45641A3C8D6E9B305F840E17E5DD157A45641740EA6B7BC05F840605E2FD757A45641051DF685C505F8409603F5DC57A45641A7E4C554CE05F840D46DAEE257A45641B7551424D705F840639C5BE857A456410B60E0F3DF05F8409B8EFCED57A45641F4F328C4E805F840C94391F357A456418B01ED94F105F84043BB19F957A4564166782B66FA05F84063F495FE57A456411049E3370306F84076EE050458A45641E662130A0C06F840D9A8690958A45641BAB5BADC1406F840EA22C10E58A456419931D8AF1D06F840FB5B0C1458A4564114C66A832606F84070534B1958A45641BF6271572F06F840A5087E1E58A4564166F7EA2B3806F840F97AA42358A456412073D6004106F840CCA9BE2858A45641F1C532D64906F8408594CC2D58A45641B3DEFEAB5206F840833ACE3258A4564163AD39825B06F8402F9BC33758A45641DC20E2586406F840EEB5AC3C58A45641A528F72F6D06F840288A894158A45641C3B377077606F84049175A4658A4564184B162DF7E06F840BC5C1E4B58A45641F710B7B78706F840EA59D64F58A456411CC173909006F8404A0E825458A456413EB197699906F8404379215958A456411CD02143A206F8404B9AB45D58A456418C0C111DAB06F840D2703B6258A45641C25564F7B306F84050FCB56658A45641499A1AD2BC06F840393C246B58A45641E7C832ADC506F8400330866F58A4564197D0AB88CE06F84029D7DB7358A45641A59F8464D706F8402231257858A456413E25BC40E006F8406F3D627C58A45641754F511DE906F8408AFB928058A456413D0D43FAF106F840EF6AB78458A45641D64C90D7FA06F840248BCF8858A45641C1FC37B50307F840A65BDB8C58A45641750B39930C07F840FADBDA9058A45641686792711507F840A20BCE9458A4564112FF42501E07F8402AEAB49858A456413AC0492F2707F84016778F9C58A45641C399A50E3007F840EFB15DA058A45641727955EE3807F8403F9A1FA458A45641B24D58CE4107F840932FD5A758A456417C04ADAE4A07F84078717EAB58A456413D8C528F5307F8407D5F1BAF58A45641ACD247705C07F84035F9ABB258A45641BBC58B516507F8402E3E30B658A45641D1531D336E07F840FE2DA8B958A456419F6AFB147707F8403AC813BD58A456414FF824F77F07F840760C73C058A4564152EA98D98807F8404DFAC5C358A45641D22E56BC9107F84057910CC758A45641ADB35B9F9A07F84031D146CA58A456415A66A882A307F84072B974CD58A45641F0343B66AC07F840BD4996D058A45641DF0C134AB507F840B181ABD358A4564105DC2E2EBE07F840ED60B4D658A4564104908D12C707F84014E7B0D958A4564180162EF7CF07F840C813A1DC58A45641D55C0FDCD807F840B2E684DF58A45641A95030C1E107F840775F5CE258A45641CEDF8FA6EA07F840BE7D27E558A4564164F72C8CF307F8403541E6E758A4564106850672FC07F84082A998EA58A456410F761B580508F84055B63EED58A4564111B86A3E0E08F8405B67D8EF58A456416138F3241708F84045BC65F258A4564156E4B30B2008F840C4B4E6F458A4564108A9ABF22808F84089505BF758A456413C74D9D93108F840498FC3F958A4564108333CC13A08F840BD701FFC58A456417DD2D2A84308F84096F46EFE58A45641EA3F9C904C08F8408F1AB20059A456418E6897785508F84068E2E80259A45641BB39C3605E08F840D54B130559A456413CA01E496708F8409656310759A45641CC89A8317008F8406B02430959A45641F8E25F1A7908F840144F480B59A45641059943038208F8404F3C410D59A45641F29852EC8A08F840E2C92D0F59A4564139D08BD59308F84092F70D1159A456415F2BEEBE9C08F84024C5E11259A456419D9778A8A508F8406332A91459A45641B8012A92AE08F840113F641659A456411957017CB708F840FFEA121859A456417E84FD65C008F840F435B51959A45641A3761D50C908F840C31F4B1B59A45641EE1A603AD208F84038A8D41C59A456419F5DC424DB08F84027CF511E59A45641222C490FE408F8405C94C21F59A456415D73EDF9EC08F840AEF7262159A45641CA1FB0E4F508F840F2F87E2259A45641891E90CFFE08F840FF97CA2359A456414D5C8CBA0709F840AAD4092559A45641BCC5A3A51009F840D1AE3C2659A456413348D5901909F8404B26632759A4564114D01F7C2209F840F73A7D2859A45641144A82672B09F840B1EC8A2959A456413AA3FB523409F8405E3B8C2A59A4564135C88A3E3D09F840D626812B59A4564198A52E2A4609F84004AF692C59A456417F28E6154F09F840C6D3452D59A45641473DB0015809F8400295152E59A45641C4D08BED6009F840A3F2D82E59A45641C2CF77D96909F84090EC8F2F59A45641DF2673C57209F840B1823A3059A45641E0C27CB17B09F840F3B4D83059A456415D90939D8409F84041836A3159A456411A7CB6898D09F8408BEDEF3159A45641E172E4759609F840C3F3683259A456413F611C629F09F840D595D53259A45641BA335D4EA809F840BAD3353359A456414ED7A53AB109F84062AD893359A456414938F526BA09F840C322D13359A45641D6434A13C309F840D8330C3459A456410AE6A3FFCB09F84096E03A3459A45641D10B01ECD409F840FB285D3459A45641EAA160D8DD09F840FD0C733459A45641C994C1C4E609F840A18C7C3459A4564125D122B1EF09F840E1A7793459A45641AF43839DF809F840BC5E6A3459A4564113D9E189010AF8403AB14E3459A45641037E3D760A0AF8405A9F263459A45641F11E9562130AF8401E29F23359A45641B8A8E74E1C0AF840924EB13359A45641CD07343B250AF840BB0F643359A45641482979272E0AF840A36C0A3359A4564154F9B513370AF8405665A43259A45641D164E9FF3F0AF840DDF9313259A456415B5812EC480AF8404A2AB33159A45641CDC02FD8510AF840A7F6273159A45641858A40C45A0AF840095F903059A456418DA243B0630AF8408263EC2F59A4564147F5379C6C0AF84024043C2F59A45641BE6F1C88750AF84007417F2E59A4564145FEEF737E0AF8403F1AB62D59A45641E68DB15F870AF840E48FE02C59A45641300B604B900AF84010A2FE2B59A45641E462FA36990AF840E150102B59A45641CE817F22A20AF840719C152A59A45641AE54EE0DAB0AF840DF840E2959A4564144C845F9B30AF8404A0AFB2759A4564156C984E4BC0AF840D32CDB2659A456419644AACFC50AF840A0ECAE2559A45641FF26B5BACE0AF840D149762459A45641105DA4A5D70AF8408F44312359A45641F4D37690E00AF840FDDCDF2159A4564160782B7BE90AF8404A13822059A456413F37C165F20AF8409AE7171F59A4564144FD3650FB0AF8401A5AA11D59A456418FB78B3A040BF840FC6A1E1C59A45641CF52BE240D0BF840691A8F1A59A4564125BCCD0E160BF8409468F31859A4564137E0B8F81E0BF840AC554B1759A4564120AC7EE2270BF840E6E1961559A45641C10C1ECC300BF840760DD61359A456412EEF95B5390BF84092D8081259A456417C40E59E420BF84074432F1059A4564184ED0A884B0BF840514E490E59A4564191E30571540BF84068F9560C59A45641400FD5595D0BF840F244580A59A456410F5E7742660BF8402D314D0859A45641CEBCEB2A6F0BF8405ABE350659A45641FF183113780BF840B5EC110459A45641655F46FB800BF84085BCE10159A45641487D2AE3890BF8400B2EA5FF58A45641E15FDCCA920BF8408B415CFD58A4564167F45AB29B0BF84050F706FB58A456411928A599A40BF8409B4FA5F858A4564161E8B980AD0BF840BD4A37F658A4564140229867B60BF840FCE8BCF358A4564121C33E4EBF0BF840A42A36F158A4564168B8AC34C80BF8400910A3EE58A4564185EFE01AD10BF840739903EC58A45641A555DA00DA0BF84036C757E958A456415CD897E6E20BF840A8999FE658A45641176518CCEB0BF8401811DBE358A456416BE95AB1F40BF840DB2D0AE158A4564181525E96FD0BF8404AF02CDE58A456415F8E217B060CF840C05843DB58A45641268AA35F0F0CF84093674DD858A45641DD33E343180CF8401F1D4BD558A45641D978DF27210CF840C1793CD258A45641AD46970B2A0CF840D77D21CF58A45641518B09EF320CF840C329FACB58A45641563435D23B0CF840E37DC6C858A45641B32F19B5440CF8409E7A86C558A45641B76AB4974D0CF84055203AC258A45641D0D3057A560CF8406D6FE1BE58A456417C580C5C5F0CF8404F687CBB58A45641B1E6C63D680CF840660B0BB858A456419B6C341F710CF84018598DB458A45641B4D753007A0CF840D35103B158A456419D1624E1820CF84003F66CAD58A45641C616A4C18B0CF8401A46CAA958A4564196C6D2A1940CF84082421BA658A456412514AF819D0CF840B3EB5FA258A4564198ED3761A60CF8401E42989E58A456414B416C40AF0CF8403546C49A58A4564117FD4A1FB80CF84071F8E39658A45641910FD3FDC00CF8404959F79258A45641066703DCC90CF8403769FE8E58A45641CAF1DAB9D20CF840B228F98A58A45641269E5897DB0CF8403A98E78658A45641A25A7B74E40CF8404BB8C98258A45641BF154251ED0CF84064899F7E58A4564141BEAB2DF60CF840050C697A58A456412842B709FF0CF840B240267658A45641A59063E5070DF840EC27D77158A45641FA97AFC0100DF84039C27B6D58A4564116479A9B190DF8402110146958A45641A58C2276220DF8402912A06458A45641935747502B0DF840DDC81F6058A456419096072A340DF840C534935B58A45641B83862033D0DF8407056FA5658A45641B82C56DC450DF8406B2E555258A45641A461E2B44E0DF84045BDA34D58A456419AC6058D570DF8409103E64858A45641B34ABF64600DF840DE011C4458A4564100DD0D3C690DF840C1B8453F58A45641D16CF012720DF840D028633A58A4564138E965E97A0DF840A052743558A456417E416DBF830DF840CA36793058A45641586505958C0DF840EAD5712B58A456419E432D6A950DF84098305E2658A456413ECCE33E9E0DF84072473E2158A456413DEE2713A70DF840161B121C58A45641C899F8E6AF0DF84024ACD91658A45641DBBD54BAB80DF8403DFB941158A456419F4A3B8DC10DF8400309440C58A456417F2FAB5FCA0DF8401BD6E60658A45641685CA331D30DF84028637D0158A45641FEC02203DC0DF840D5B007FC57A45641984D28D4E40DF840C7BF85F657A456419FF1B2A4ED0DF840A990F7F057A45641649DC174F60DF84027245DEB57A45641C4405344FF0DF840EC7AB6E557A4564143CC6613080EF840AA9503E057A456417A2FFBE1100EF840117544DA57A456412D5B0FB0190EF840CD1979D457A45641673FA27D220EF8409384A1CE57A45641A4CCB24A2B0EF84018B6BDC857A4564124F33F17340EF84014AFCDC257A456419FA348E33C0EF8403F70D1BC57A456418FCECBAE450EF8404BFAC8B657A456416564C8794E0EF840F64DB4B057A45641D6553D44570EF840FC6B93AA57A45641FE93290E600EF840195566A457A45641140F8CD7680EF8400B0A2D9E57A456416BB863A0710EF840998BE79757A45641EA80AF687A0EF8407ADA959157A4564130596E30830EF84078F7378B57A45641C9329FF78B0EF84055E3CD8457A4564193FE40BE940EF840D59E577E57A45641CFAD52849D0EF840C52AD57757A456419A31D349A60EF840E687467157A45641A67BC10EAF0EF8400CB7AB6A57A45641047D1CD3B70EF840FCB8046457A456416D27E396C00EF840838E515D57A456411E6C145AC90EF8407338925657A45641083DAF1CD20EF8409BB7C64F57A45641DD8BB2DEDA0EF840CC0CEF4857A45641124A1DA0E30EF840DA380B4257A456419069EE60EC0EF8409A3C1B3B57A4564176DC2421F50EF840E0181F3457A456417094BFE0FD0EF84084CE162D57A45641CE83BD9F060FF840625E022657A45641AC9C1D5E0F0FF84052C9E11E57A45641ECD0DE1B180FF8402E10B51757A456414E1300D9200FF840D8337C1057A45641AC558095290FF8402B35370957A45641C38A5E51320FF8400C15E60157A45641E2A4990C3B0FF84056D488FA56A45641FB9630C7430FF840F0731FF356A456411C5322814C0FF840BFF4A9EB56A45641A5CC6D3A550FF840AA5728E456A45641DDF511F35D0FF840959D9ADC56A45641E9C10DAB660FF8406EC700D556A45641B42360626F0FF8401BD65ACD56A45641610E0819780FF8408BCAA8C556A45641157504CF800FF840A9A5EABD56A45641B24A5484890FF840666820B656A45641CA82F638920FF840B2134AAE56A45641B310EAEC9A0FF8407DA867A656A45641BEE72DA0A30FF840BE27799E56A45641B2FBC052AC0FF84067927E9656A456411640A204B50FF8406FE9778E56A4564177A8D0B5BD0FF840CC2D658656A45641C8284B66C60FF8407860467E56A45641DDFF5C4A661AF840E4C4B9884CA45641'
    # testgeom = '0106000020490D0000060000000103000000010000000700000070609DEB19F0F740C12DDFE2F1A2564100000000A0EDF7409F9A6BB6FCA2564100000000A0EDF740A09A6BB6FCA256411D563BC5F7ECF7405BD2EE95FFA25641B329106388EEF740941B68BEF8A256418329106388EEF740941B68BEF8A2564170609DEB19F0F740C12DDFE2F1A256410103000000010000003500000000000000A0EDF7405F85A51DA3A356410AD7A370D9F1F74052B81E8590A35641D7A3703D12F0F740F6285C6F8AA3564114AE47E15EF8F740F5285CEF63A35641E17A14AEE7F6F740B81E850B5EA356417B14AE47E1FDF740A5703D6A3DA35641EC51B81E89FAF740A4703DFA31A35641A4703D0AE702F8403E0AD7330DA35641E24A55E9B0F8F74085EBE844E7A256410000000090F8F74085EBE844E7A256410000000090F8F740130ED18EEDA256410000000000F7F740130ED18EEDA256410000000070F5F740130ED18EEDA256410000000070F5F740371D546AF0A2564100000000E0F3F740371D546AF0A2564100000000E0F3F74051AC5243F1A256410000000050F2F74051AC5243F1A256410000000050F2F740C12DDFE2F1A2564100000000C0F0F740C12DDFE2F1A2564100000000C0F0F740C22DDFE2F1A256410000000050F2F740C22DDFE2F1A256410000000050F2F74044FB8A2DF8A2564100000000C0F0F74044FB8A2DF8A2564100000000C0F0F740941B68BEF8A256410000000030EFF740941B68BEF8A256410000000030EFF7405BD2EE95FFA2564100000000A0EDF7405BD2EE95FFA2564100000000A0EDF740C964630507A3564100000000A0EDF740E8C6434F0DA3564100000000A0EDF740D74AF49813A3564100000000A0EDF7404C5C4FE219A3564100000000A0EDF7402C04CA2D20A3564100000000A0EDF7401B98957726A3564100000000A0EDF7406F8E69C12CA3564100000000A0EDF7407579570C33A3564100000000A0EDF740C4344F5639A3564100000000A0EDF7402D41709F3FA3564100000000A0EDF74011B590E945A3564100000000A0EDF740E6005C334CA3564100000000A0EDF740BA6B107D52A3564100000000A0EDF7401D9209C858A3564100000000A0EDF7407D717A125FA3564100000000A0EDF740A1E5995B65A3564100000000A0EDF74078B4A1A66BA3564100000000A0EDF7409EC7B3EF71A3564100000000A0EDF7405B61193B78A3564100000000A0EDF740BCD90C877EA3564100000000A0EDF7405F0E2AD284A3564100000000A0EDF740B839171D8BA3564100000000A0EDF7409C148E6691A3564100000000A0EDF740CCE0E4B097A3564100000000A0EDF7405C1BDFFA9DA3564100000000A0EDF7405F85A51DA3A35641010300000001000000040000000000000010ECF740642B9264A4A356410000000010ECF7404BF174FEA9A356418333B2BB55EDF740642B9264A4A356410000000010ECF740642B9264A4A35641010300000001000000070000000000000010ECF7404BF174FEA9A35641B83C447D09ECF74024F21D1BAAA356410000000080EAF74024F21D1BAAA356410000000080EAF74025F21D1BAAA35641983C447D09ECF74025F21D1BAAA356410CE04A910CECF7401A09910DAAA356410000000010ECF7404BF174FEA9A3564101030000000100000004000000FF76FFE2DDE4F7404F2233DCD0A356418FC2F52870E5F740B91E850BD3A35641FF5D3563E9E5F7404F2233DCD0A35641FF76FFE2DDE4F7404F2233DCD0A35641010300000002000000070000000000000040E4F7402DD87880CEA35641C8748A440AE2F7402A28390DC6A356412E7625ECD9E3F74006C825FACCA35641AD01DACDEDE3F740E4CF2B46CDA35641DD46F562EAE3F74046641A39CDA35641B89176F7EDE3F74032EDCA46CDA356410000000040E4F7402DD87880CEA3564104000000C8748A440AE2F7402A28390DC6A35641C92270598FE3F740F5ABFEDCCBA35641C22270598FE3F740F5ABFEDCCBA35641C8748A440AE2F7402A28390DC6A35641'

    cells_y = 25
    cells_x = 10
    index = 0
    testgeom = cleanAPolygon(testgeom)
    print(testgeom)

    xmin,xmax,ymin,ymax = getFourPointsFromPolygonGeom(testgeom)
    yaverageArea = getAreaFromPolygonGeom(testgeom)/cells_x
    xaverageArea = yaverageArea/cells_y

    ytol = yaverageArea/500
    xtol = xaverageArea/500

    print('yaverage',yaverageArea)
    print('xaverageArea',xaverageArea)
    yBigParcel = testgeom
    xBigParcel = None

    width = xmax-xmin
    length = ymax-ymin

    dx = width/cells_x
    dy = length/cells_y

    ystep = dy/500
    xstep = dx/500


    X = xmin


    for j in range(cells_x):
        if j == cells_x-1:
            VerticalParcel = yBigParcel
            xBigParcel = VerticalParcel
            yBigParcel = None
        else:
            X = X+dx
            line_geom = makeALine(str(X),str(ymin),str(X),str(ymax))
            VerticalParcel,remainingParcel = splitPolygon(yBigParcel,line_geom,'h')
            VerticalParcelArea = getAreaFromPolygonGeom(VerticalParcel)
            VerticalParcel,yBigParcel = adjustYSplit(VerticalParcel,remainingParcel,yBigParcel,yaverageArea,line_geom,ytol,ystep,ymin,ymax)#update parcels
            xBigParcel = VerticalParcel
        print(getAreaFromPolygonGeom(VerticalParcel))


        query = "INSERT INTO public.splitp(cell_id, geom) VALUES ("+str(index+999)+",'"+VerticalParcel+"');"
        cursor.execute(query)
        conn.commit()

        for i in range(cells_y):
            if i==cells_y-1:
                HorizentalParcel = xBigParcel
                query = "INSERT INTO public.splitp(cell_id, geom) VALUES ("+str(index)+",'"+HorizentalParcel+"');"
                cursor.execute(query)
                conn.commit()
                print(getAreaFromPolygonGeom(HorizentalParcel))
            else:
                nowXmin, nowXmax, nowYmin, nowYmax = getFourPointsFromPolygonGeom(xBigParcel)
                nowdy = (nowYmax - nowYmin) / (cells_y-i)
                horizental_line_geom = makeALine(str(nowXmin),str(float(nowYmax)-nowdy),str(nowXmax),str(float(nowYmax)-nowdy))
                HorizentalParcel,remainingParcel = splitPolygon(xBigParcel,horizental_line_geom,'v')
                HorizentalParcelArea = getAreaFromPolygonGeom(HorizentalParcel)
                HorizentalParcel,xBigParcel = adjustXSplit(HorizentalParcel,remainingParcel,xBigParcel,xaverageArea,horizental_line_geom,xtol,xstep,xmin,xmax)
                HorizentalParcelArea = getAreaFromPolygonGeom(HorizentalParcel)
                query = "INSERT INTO public.splitp(cell_id, geom) VALUES ("+str(index)+",'"+HorizentalParcel+"');"
                cursor.execute(query)
                conn.commit()
                print(HorizentalParcelArea)

            i+=1
            index+=1
            print(index)

        j+=1
